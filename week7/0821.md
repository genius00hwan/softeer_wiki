# 2025-08-21(목) 일지

## 오늘 한 일
- FE 정책 변경 대응: 404 → 200 + 빈값 으로 합의 후 BE 응답 포맷 정리  
  - 급히 맞추는 과정에서 일부 엔드포인트가 빈 컬렉션 대신 `null`을 반환 -> FE 쪽에서 분기 누락으로 에러 연쇄
  - 컨트롤러/서비스 반환 규칙 통일: 리스트,맵은 빈 컬렉션, 단일 객체는 `Optional` 또는 404로 명확화
- NPE 트러블슈팅 다수
  - DTO 필드 중 Integer/Boolean 래퍼 타입에 디폴트 미지정 -> 연산 시 NPE
  - JPA 쿼리 결과 `null` 처리 누락, `Map.get()` 이후 체이닝에서 NPE
  - 검증 어노테이션은 있었지만 서비스 내부 가드가 부족했던 구간 보완
  
- 문자 전송 상태 플로우 구현/정리
  - 예약 발송 vs 즉시 발송 분기
  - 상태별 사용자 검증: 수급자 연락처/수신 동의/센터 설정 유효성 체크
  - 예약건 스케줄러가 `REPORT_RESERVED`를 `REPORT_SENDING`으로 전환 후 이벤트 발행
  - 콜백 수신 시 최종 상태 반영 및 동일 작업 재실행 방지(멱등키 기반)

## 배운 점, 느낀 점
- NPE는  작은 부주의가 체인처럼 이어져서 터진다.
- 속도와 꼼꼼함은 대체재가 아니라 보완재. 체크리스트와 규칙을 몸에 붙이면 속도를 해치지 않고 꼼꼼해질 수 있다.
- 문서의 상태 관리는 기능이 아니라 집중력 게임에 가깝다. 다행히 비즈니스 흐름을 정확히 이해하고 있어서 끝까지 해나가고 있는 것 같다.

### 기술 메모(오늘 채워 넣은 것)

- NPE 방지 가드(서비스 진입부 공통 룰)
  - 서비스 내부는 requireNonNull 가드 절 반영 (`if (x == null) throw ...`)
  - 컬렉션은 생성 시점부터 emptyList() 기본
  - DTO → 엔티티 매핑 시 래퍼 타입 디폴트 지정(예: `Boolean.TRUE/FALSE`, 센티널 값)

- 상태 전이(간이 표)
  - 문서: `SHEET_DONE → REPORT_PENDING → REPORT_REVIEWED → REPORT_RESERVED → REPORT_SENDING → (REPORT_SENT | REPORT_FAILED)`

- 멱등성/동시성
  - 문자 발송 요청 단위로 `idempotencyKey=report-job-idempotency-key-{documentId}` 적용
  - 중복 전송 방지: 전이 전에 현재 상태 재확인(낙관 잠금 또는 `where status in (...)` 업데이트)
- 스케줄러 & 예약 처리
  - `0,30 * * * *` 주기: 현재시각 `>= reservedSendTime` 인 문서만 집계
  - 배치 단위 오류 격리: 날짜별 그룹 처리, try-catch로 개별 실패 로깅


### 오늘의 회고
- “급할수록 기본에”: 반환 규약/가드 절/상태 매트릭스 같은 지루한 기본이 속도를 만든다.
- 다음 프로젝트에선 초반 1~2일을 규칙 정리에 더 투자하자. 그러면 개발 막판 속도가 훨씬 빨라질 것.
- 속도와 꼼꼼함을 동시에 가지려면, “규칙을 몸에 붙이는 훈련”이 먼저다.
